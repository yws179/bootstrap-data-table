/*
 * Plugin:  bootstrap-data-table
 * Author:  Weisen Yan (严伟森)
 * Version: 0.1.1
 * Email:   yws179@gmail.com
 * Github:  https://github.com/yws179/bootstrap-data-table
 * Licensed under the MIT license
 */
(function(p){p.fn.dataTable=function(e){var s=arguments;return this.each(function(){var t=p(this),i=t.data("dataTable"),a=typeof e=="object"&&e;if(!i){i=new n(t,a);t.data("dataTable",i)}if("string"===typeof e){i[e].apply(i,Array.prototype.slice.call(s,1))}})};var n=function(t,i){if(!t.is("table")){throw new Error("This is not <table> DOM")}this.$table=t;this.$caption=this.$table.find("caption");this.$thead=this.$table.find("thead");this.$tbody=this.$table.find("tbody");this.$pagination=this.$table.siblings(".pagination");this.options=i||{};this.data=this.options.data||[];this.visibleData=this.data;this.visibleCondition={};this.preProcessor=this.options.preProcessor;this.buttons=this.options.buttons||[];this.refreshable=this.options.refreshable;this.filterable=this.options.filterable;this.operate=this.options.operate;this.totalLabel=this.options.totalLabel||"";this.totalElements=0;this.pageable=this.options.pageable;this.pageSize=this.options.pageSize||10;this.sizeSelector=this.options.sizeSelector||{};this.page=this.options.page||1;this._init()};n.prototype={constructor:n,_init:function(){this.$table.addClass("table table-striped table-bordered table-hover bs-data-table");if(this.$caption.length<1){this.$caption=p("<caption></caption>");this.$table.prepend(this.$caption)}if(this.$thead.length<1){this.$thead=p("<thead></thead>");this.$caption.after(this.$thead)}if(this.$tbody.length<1){this.$tbody=p("<tbody></tbody>");this.$thead.after(this.$tbody)}this.rendCaption();this.renderHead();this.renderData()},rendCaption:function(){var t=p('<div class="btn-group pull-right"></div>');for(var i=0;i<this.buttons.length;i++){var a=this.buttons[i],e=p(a.dom);for(var s in a.events){e.on(s,a.events[s])}t.append(e)}if(this.refreshable){var e=p('<button class="btn btn-default btn-refresh" type="button" title="刷新"><span class="glyphicon glyphicon-refresh"></span></button>');e.on("click",function(){var t=this.$thead.find("tr.bs-data-table-filter");t.find(":input").val("");t.find(":input:first()").change()}.bind(this));t.append(e)}if(this.filterable){t.append('<button class="btn btn-default btn-filter" type="button" title="过滤器"><span class="glyphicon glyphicon-filter"></span></button>')}this.$caption.append(t);if(this.options.title){this.$caption.prepend(this.options.title)}},renderHead:function(){var t=p("<tr></tr>");for(var i in this.options.fields){var a=p('<div class="pull-right"></div>').append('<div class="btn-sort" data-sort-by=":sort-by" data-order="asc"><span class="glyphicon glyphicon-chevron-up"></span></div>'.replace(":sort-by",i)).append('<div class="btn-sort" data-sort-by=":sort-by" data-order="desc"><span class="glyphicon glyphicon-chevron-down"></span></div>'.replace(":sort-by",i));t.append(p("<th>"+this.options.fields[i]+"</th>").append(a))}if(this.operate){t.append("<th>"+(this.options.operate.field||"operate")+"</th>")}this.$thead.prepend(t);var e=this;this.$thead.find(".btn-sort").click(function(){var t=p(this),i=t.data("sort-by"),a=t.data("order");r(e.data,i,a=="desc");e.renderData()});if(this.filterable){if(this.$thead.find(".bs-data-table-filter").length<1){var s=p('<tr class="bs-data-table-filter"></tr>');for(var i in this.options.fields){s.append('<th><input class="form-control" name=":name"></th>'.replace(":name",i))}if(this.operate){s.append('<th><button class="btn btn-default btn-reset-filter"><span class="glyphicon glyphicon-repeat"></span></button></th>')}this.$thead.append(s)}var s=s||this.$thead.find(".bs-data-table-filter");if(this.operate){s.find(".btn-reset-filter").click(function(){var t=s.find(":input");t.val("");t.change()})}this.$caption.find(".btn-filter").click(function(){p(this).toggleClass("active");s.toggle();s.find(":input").val("");s.find(":input:first()").change()});this.$table.on("change keyup paste",".bs-data-table-filter :input",function(){var a={};this.$table.find(".bs-data-table-filter :input").each(function(){var t=p(this).attr("name");var i=p(this).val();if(p(this).data("strict")){l(a,t+"-strict",true)}l(a,t,i)});this.visibleCondition=a;this.renderData()}.bind(this))}},renderData:function(t){this.data=t||this.data;this.visibleData=o(this.data,this.visibleCondition);this.totalElements=this.visibleData.length;var i=Math.ceil(this.visibleData.length/this.pageSize);if(this.pageable){if(this.page>i){this.page=i}if(i>0&&this.page<1){this.page=1}this.visibleData=Array.prototype.slice.call(this.visibleData,(this.page-1)*this.pageSize,Math.min(this.page*this.pageSize,this.visibleData.length))}this.$tbody.html("");if(this.visibleData.length<1){this.$tbody.append('<tr><td class="text-center" colspan=":colspan"> ---- · ---- </td></tr>'.replace(":colspan",this.$thead.find("tr:first() th").length))}else{for(var a=0;a<this.visibleData.length;a++){var e=p("<tr></tr>"),s=this.preProcessor?this.preProcessor(u(this.visibleData[a])):this.visibleData[a];for(var n in this.options.fields){e.append("<td>"+(c(s,n)||"")+"</td>")}if(this.operate){e.append("<td>"+this.operate.content+"</td>")}this.$tbody.append(e)}}if(this.pageable){this.renderPagination(i)}},renderPagination:function(t){var i=d(this.page,t),a=p('<div class="bs-data-table-pagination"></div>'),e=p('<input class="form-control bs-data-table-page-select" type="number" min="1" max=":totalPage" value=":currentPage">'.replace(":currentPage",this.page).replace(":totalPage",t)),s=p('<ul class="pagination bs-data-table-pagination"></ul>');a.append("<span>"+this.totalLabel.replace("${total}",this.totalElements)+"</span>");var n=p('<li data-page="1"><a href="javascript:void(0);">&laquo;</a></li>');if(this.page<=1){n.addClass("disabled")}s.append(n);for(var r=0;r<i.length;r++){var o=p('<li data-page=":num"><a href="javascript:void(0);">:num</a></li>'.replace(/:num/g,i[r]));if(i[r]==this.page){o.addClass("active")}s.append(o)}var h=p('<li data-page=":totalPage"><a href="javascript:void(0);">&raquo;</a></li>'.replace(":totalPage",t));if(this.page==t){h.addClass("disabled")}s.append(h);a.append(s);if(t>0){a.append('<span class="bs-data-table-page-total">/&nbsp;:totalPage</span>'.replace(":totalPage",t));a.append(e)}a.append(this.buildSizeSelector());if(this.$pagination.length>0){this.$pagination.replaceWith(a);this.$pagination=a}else{this.$pagination=a;this.$table.after(this.$pagination)}var l=this;a.on("change",".bs-data-table-page-select",function(){l.page=p(this).val();l.renderData()}).on("click",".pagination li",function(){if(p(this).is(".disabled"))return;l.page=p(this).data("page");l.renderData()}).on("change",".bs-data-table-size-select",function(){l.pageSize=p(this).val();l.renderData()})},buildSizeSelector:function(){var t=this.sizeSelector.title,i=this.sizeSelector instanceof Array?this.sizeSelector:this.sizeSelector.list,a=p('<select class="form-control bs-data-table-size-select"></select>');if(i){for(var e=0;e<i.length;e++){a.append('<option value="'+i[e]+'">'+i[e]+"</option>")}a.find('option[value="'+this.pageSize+'"]').prop("selected",true)}if(t){a=p('<div class="pull-right"><span>'+t+"</span></div>").append(a)}return a},getIdx:function(t,i){i.apply(this,this.data.indexOf(t))},getData:function(t,i){var a=[];if(t instanceof Array){t.forEach(function(t){a.push(this.data[t])}.bind(this));i.apply(this,[a])}else{i.apply(this,[this.data[t]])}},getAllData:function(t){t.apply(this,this.data)},addData:function(t){if(t instanceof Array){t.forEach(function(t){this.data.push(t)}.bind(this))}else{this.data.push(t)}this.renderData()},removeData:function(t){if(t instanceof Array){t.forEach(function(t){this.data.splice(t,1)}.bind(this))}else{this.data.splice(t,1)}this.renderData()},replaceData:function(t,i){this.data.splice(t,1,i);this.renderData()},event:function(t){var a=this,i,e;if(arguments.length>2){i=arguments[1];e=arguments[2]}else{i="";e=arguments[1]}this.$tbody.on(t,"tr "+i,function(){var t=p(this).is("tr")?p(this).index():p(this).parentsUntil("tbody","tr").index(),i=a.visibleData[t];e.apply(this,[a.data.indexOf(i),i])})}};var r=function(t,a,i){t.sort(function(t,i){return e(t,i,a)});if(i){t.reverse()}};var e=function(t,i,a){if(a){t=c(t,a);i=c(i,a)}if(/^\d+$/.test(t)&&/^\d+$/.test(i)){t=Number(t);i=Number(i)}if(t>i||!i){return 1}else if(t<i||!t){return-1}return t.id>i.id?1:-1};var o=function(t,i){var a=[];t.forEach(function(t){if(!s(t,i)){a.push(t)}});return a};var s=function(t,i){for(var a in i){if(!i.hasOwnProperty(a)||a.endsWith("-strict")){continue}if(i[a+"-strict"]&&t[a]!=i[a]){return true}else if((t[a]+"").indexOf(i[a])==-1){return true}}return false};function d(t,i){var a=[],e=5,s=1;if(i<1){a.push(1);return a}if(i<=e){for(var n=1;n<=i;n++){a.push(n)}return a}s=t-Math.floor(e/2);s=s>0?s:1;s=s+e>i?i-e+1:s;for(var n=0;n<e;n++){a.push(s+n)}return a}var h=function(t){return t==undefined||t==""};var l=function(t,i,a,e){if(!h(t)&&!h(i)&&!h(a)){f(t,i,a,e)}};var f=function(t,i,a,e){var s=i.indexOf(".");if(s==-1){if(e=="list"){t[i]=t[i]||[];t[i].push(a)}else{t[i]=a}return}var n=i.substr(0,s);if(h(t[n])){t[n]={}}f(t[n],i.substr(s+1),a,e)};var c=function(t,i){return h(t)||h(i)?undefined:b(t,i)};var b=function(t,i){var a=i.indexOf(".");if(a==-1){return t[i]}var e=i.substr(0,a);if(h(t[e])){t[e]={}}return b(t[e],i.substr(a+1))};function u(t){return JSON.parse(JSON.stringify(t))}})(jQuery);