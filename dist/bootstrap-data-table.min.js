/*
 * Plugin:  bootstrap-data-table
 * Author:  Weisen Yan (严伟森)
 * Version: 0.1.0
 * Email:   yws179@gmail.com
 * Github:  https://github.com/yws179/bootstrap-data-table
 * Licensed under the MIT license
 */
!function(d){d.fn.dataTable=function(i){var e=arguments;return this.each(function(){var t=d(this),a=t.data("dataTable");a||(a=new n(t,"object"==typeof i&&i),t.data("dataTable",a)),"string"==typeof i&&a[i].apply(a,Array.prototype.slice.call(e,1))})};var n=function(t,a){if(!t.is("table"))throw new Error("This is not <table> DOM");this.$table=t,this.$caption=this.$table.find("caption"),this.$thead=this.$table.find("thead"),this.$tbody=this.$table.find("tbody"),this.$pagination=this.$table.siblings(".pagination"),this.options=a||{},this.data=this.options.data||[],this.visibleData=this.data,this.visibleCondition={},this.buttons=this.options.buttons||[],this.refreshable=this.options.refreshable,this.filterable=this.options.filterable,this.pageable=this.options.pageable,this.pageSize=this.options.pageSize||10,this.page=this.options.page||1,this._init()};n.prototype={constructor:n,_init:function(){this.$table.addClass("table table-striped table-bordered table-hover data-table"),this.$caption.length<1&&(this.$caption=d("<caption></caption>"),this.$table.prepend(this.$caption)),this.$thead.length<1&&(this.$thead=d("<thead></thead>"),this.$caption.after(this.$thead)),this.$tbody.length<1&&(this.$tbody=d("<tbody></tbody>"),this.$thead.after(this.$tbody)),this.rendCaption(),this.renderHead(),this.renderData()},rendCaption:function(){var t=d('<div class="btn-group pull-right"></div>');for(var a in this.buttons){var i=this.buttons[a],e=d(i.dom);for(var n in i.events)e.on(n,i.events[n]);t.append(e)}this.refreshable&&((e=d('<button class="btn btn-default btn-refresh" type="button" title="刷新"><span class="glyphicon glyphicon-refresh"></span></button>')).on("click",function(){var t=this.$thead.find("tr.data-table-filter");t.find(":input").val(""),t.find(":input:first()").change()}.bind(this)),t.append(e));this.filterable&&t.append('<button class="btn btn-default btn-filter" type="button" title="过滤器"><span class="glyphicon glyphicon-filter"></span></button>'),this.$caption.append(t),this.options.title&&this.$caption.prepend(this.options.title)},renderHead:function(){var t=d("<tr></tr>");for(var a in this.options.fields){var i=d('<div class="pull-right"></div>').append('<div class="btn-sort" data-sort-by=":sort-by" data-order="asc"><span class="glyphicon glyphicon-chevron-up"></span></div>'.replace(":sort-by",a)).append('<div class="btn-sort" data-sort-by=":sort-by" data-order="desc"><span class="glyphicon glyphicon-chevron-down"></span></div>'.replace(":sort-by",a));t.append(d("<th>"+this.options.fields[a]+"</th>").append(i))}this.$thead.append(t);var e=this;if(this.$thead.find(".btn-sort").click(function(){var t=d(this),a=t.data("sort-by"),i=t.data("order");s(e.data,a,"desc"==i),e.renderData()}),this.filterable){var n=d('<tr class="data-table-filter"></tr>');for(var a in this.options.fields)n.append('<th><input class="form-control" name=":name"></th>'.replace(":name",a));this.$thead.append(n),this.$caption.find(".btn-filter").click(function(){d(this).toggleClass("active"),n.toggle(),n.find(":input").val(""),n.find(":input:first()").change()}),this.$table.on("change keyup paste",".data-table-filter :input",function(){var i={};this.$table.find(".data-table-filter :input").each(function(){var t=d(this).attr("name"),a=d(this).val();d(this).data("strict")&&p(i,t+"-strict",!0),p(i,t,a)}),this.visibleCondition=i,this.renderData()}.bind(this))}},renderData:function(t){this.data=t||this.data,this.visibleData=r(t||this.data,this.visibleCondition);var a=Math.ceil(this.visibleData.length/this.pageSize);for(var i in this.pageable&&(this.page>a&&(this.page=a),this.visibleData=Array.prototype.slice.call(this.visibleData,(this.page-1)*this.pageSize,Math.min(this.page*this.pageSize,this.visibleData.length))),this.$tbody.html(""),this.visibleData){var e=d("<tr></tr>");for(var n in this.options.fields)e.append("<td>"+(c(this.visibleData[i],n)||"")+"</td>");this.$tbody.append(e)}this.pageable&&this.renderPagination(a)},renderPagination:function(t){var a=function(t,a){var i=[],e=1;if(a<1)return i.push(1),i;if(a<=5){for(var n=1;n<=a;n++)i.push(n);return i}e=(e=0<(e=t-Math.floor(2.5))?e:1)+5>a?a-5+1:e;for(var n=0;n<5;n++)i.push(e+n);return i}(this.page,t),i=d('<div class="data-table-pagination"></div>'),e=d('<select class="form-control data-table-page-select"></select>'),n=d('<ul class="pagination data-table-pagination"></ul>');i.prepend("<span>:page / :totalPage</span>".replace(":page",this.page).replace(":totalPage",t));var s=d('<li data-page="1"><a href="javascript:void(0);">&laquo;</a></li>');for(var r in this.page<=1&&s.addClass("disabled"),n.append(s),a){var o=d('<li data-page=":num"><a href="javascript:void(0);">:num</a></li>'.replace(/:num/g,a[r]));a[r]==this.page&&o.addClass("active"),n.append(o)}var h=d('<li data-page=":totalPage"><a href="javascript:void(0);">&raquo;</a></li>'.replace(":totalPage",t));this.page==t&&h.addClass("disabled"),n.append(h),i.append(n);for(r=1;r<=t;r++){var p=d('<option value=":page">:page</option>'.replace(/:page/g,r));r==this.page&&p.prop("selected",!0),e.append(p)}i.append(e),0<this.$pagination.length?(this.$pagination.replaceWith(i),this.$pagination=i):(this.$pagination=i,this.$table.after(this.$pagination));var l=this;i.on("click change",".pagination li, .data-table-page-select",function(){console.log(this),d(this).is(".disabled")||(d(this).is("select")?l.page=d(this).val():l.page=d(this).data("page"),l.renderData())})},getIdx:function(t,a){a.apply(this,this.data.indexOf(t))},getData:function(t,a){var i=[];t instanceof Array?(t.forEach(function(t){i.push(this.data[t])}.bind(this)),a.apply(this,[i])):a.apply(this,[this.data[t]])},getAllData:function(t){t.apply(this,this.data)},addData:function(t){t instanceof Array?t.forEach(function(t){this.data.push(t)}.bind(this)):this.data.push(t),this.renderData()},removeData:function(t){t instanceof Array?t.forEach(function(t){this.data.splice(t,1)}.bind(this)):this.data.splice(t,1),this.renderData()},replaceData:function(t,a){this.data.splice(t,1,a),this.renderData()},event:function(t,a){var i=this;this.$tbody.on(t,"tr",function(){var t=i.visibleData[d(this).index()];a.apply(this,[i.data.indexOf(t),t])})}};var s=function(t,i,a){t.sort(function(t,a){return e(t,a,i)}),a&&t.reverse()},e=function(t,a,i){return i&&(t=c(t,i),a=c(a,i)),/^\d+$/.test(t)&&/^\d+$/.test(a)&&(t=Number(t),a=Number(a)),a<t||!a?1:t<a||!t?-1:t.id>a.id?1:-1},r=function(t,a){var i=[];return t.forEach(function(t){o(t,a)||i.push(t)}),i},o=function(t,a){for(var i in a)if(a.hasOwnProperty(i)&&!i.endsWith("-strict")){if(a[i+"-strict"]&&t[i]!=a[i])return!0;if(-1==(t[i]+"").indexOf(a[i]))return!0}return!1};var h=function(t){return null==t||""==t},p=function(t,a,i,e){h(t)||h(a)||h(i)||l(t,a,i,e)},l=function(t,a,i,e){var n=a.indexOf(".");if(-1!=n){var s=a.substr(0,n);h(t[s])&&(t[s]={}),l(t[s],a.substr(n+1),i,e)}else"list"==e?(t[a]=t[a]||[],t[a].push(i)):t[a]=i},c=function(t,a){return h(t)||h(a)?void 0:f(t,a)},f=function(t,a){var i=a.indexOf(".");if(-1==i)return t[a];var e=a.substr(0,i);return h(t[e])&&(t[e]={}),f(t[e],a.substr(i+1))}}(jQuery);