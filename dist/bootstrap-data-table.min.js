/*
 * Plugin:  bootstrap-data-table
 * Author:  Weisen Yan (严伟森)
 * Version: 0.1.1
 * Email:   yws179@gmail.com
 * Github:  https://github.com/yws179/bootstrap-data-table
 * Licensed under the MIT license
 */
(function(d){d.fn.dataTable=function(e){var s=arguments;return this.each(function(){var t=d(this),a=t.data("dataTable"),i=typeof e=="object"&&e;if(!a){a=new n(t,i);t.data("dataTable",a)}if("string"===typeof e){a[e].apply(a,Array.prototype.slice.call(s,1))}})};var n=function(t,a){if(!t.is("table")){throw new Error("This is not <table> DOM")}this.$table=t;this.$caption=this.$table.find("caption");this.$thead=this.$table.find("thead");this.$tbody=this.$table.find("tbody");this.$pagination=this.$table.siblings(".pagination");this.options=a||{};this.data=this.options.data||[];this.visibleData=this.data;this.visibleCondition={};this.preProcessor=this.options.preProcessor;this.buttons=this.options.buttons||[];this.refreshable=this.options.refreshable;this.filterable=this.options.filterable;this.operate=this.options.operate;this.pageable=this.options.pageable;this.pageSize=this.options.pageSize||10;this.page=this.options.page||1;this._init()};n.prototype={constructor:n,_init:function(){this.$table.addClass("table table-striped table-bordered table-hover bs-data-table");if(this.$caption.length<1){this.$caption=d("<caption></caption>");this.$table.prepend(this.$caption)}if(this.$thead.length<1){this.$thead=d("<thead></thead>");this.$caption.after(this.$thead)}if(this.$tbody.length<1){this.$tbody=d("<tbody></tbody>");this.$thead.after(this.$tbody)}this.rendCaption();this.renderHead();this.renderData()},rendCaption:function(){var t=d('<div class="btn-group pull-right"></div>');for(var a=0;a<this.buttons.length;a++){var i=this.buttons[a],e=d(i.dom);for(var s in i.events){e.on(s,i.events[s])}t.append(e)}if(this.refreshable){var e=d('<button class="btn btn-default btn-refresh" type="button" title="刷新"><span class="glyphicon glyphicon-refresh"></span></button>');e.on("click",function(){var t=this.$thead.find("tr.bs-data-table-filter");t.find(":input").val("");t.find(":input:first()").change()}.bind(this));t.append(e)}if(this.filterable){t.append('<button class="btn btn-default btn-filter" type="button" title="过滤器"><span class="glyphicon glyphicon-filter"></span></button>')}this.$caption.append(t);if(this.options.title){this.$caption.prepend(this.options.title)}},renderHead:function(){var t=d("<tr></tr>");for(var a in this.options.fields){var i=d('<div class="pull-right"></div>').append('<div class="btn-sort" data-sort-by=":sort-by" data-order="asc"><span class="glyphicon glyphicon-chevron-up"></span></div>'.replace(":sort-by",a)).append('<div class="btn-sort" data-sort-by=":sort-by" data-order="desc"><span class="glyphicon glyphicon-chevron-down"></span></div>'.replace(":sort-by",a));t.append(d("<th>"+this.options.fields[a]+"</th>").append(i))}if(this.operate){t.append("<th>"+(this.options.operate.field||"operate")+"</th>")}this.$thead.prepend(t);var e=this;this.$thead.find(".btn-sort").click(function(){var t=d(this),a=t.data("sort-by"),i=t.data("order");r(e.data,a,i=="desc");e.renderData()});if(this.filterable){if(this.$thead.find(".bs-data-table-filter").length<1){var s=d('<tr class="bs-data-table-filter"></tr>');for(var a in this.options.fields){s.append('<th><input class="form-control" name=":name"></th>'.replace(":name",a))}if(this.operate){s.append('<th><button class="btn btn-default btn-reset-filter"><span class="glyphicon glyphicon-repeat"></span></button></th>')}this.$thead.append(s)}var s=s||this.$thead.find(".bs-data-table-filter");if(this.operate){s.find(".btn-reset-filter").click(function(){var t=s.find(":input");t.val("");t.change()})}this.$caption.find(".btn-filter").click(function(){d(this).toggleClass("active");s.toggle();s.find(":input").val("");s.find(":input:first()").change()});this.$table.on("change keyup paste",".bs-data-table-filter :input",function(){var i={};this.$table.find(".bs-data-table-filter :input").each(function(){var t=d(this).attr("name");var a=d(this).val();if(d(this).data("strict")){p(i,t+"-strict",true)}p(i,t,a)});this.visibleCondition=i;this.renderData()}.bind(this))}},renderData:function(t){this.data=t||this.data;this.visibleData=o(this.data,this.visibleCondition);var a=Math.ceil(this.visibleData.length/this.pageSize);if(this.pageable){if(this.page>a){this.page=a}if(a>0&&this.page<1){this.page=1}this.visibleData=Array.prototype.slice.call(this.visibleData,(this.page-1)*this.pageSize,Math.min(this.page*this.pageSize,this.visibleData.length))}this.$tbody.html("");for(var i=0;i<this.visibleData.length;i++){var e=d("<tr></tr>"),s=this.preProcessor?this.preProcessor(u(this.visibleData[i])):this.visibleData[i];for(var n in this.options.fields){e.append("<td>"+(c(s,n)||"")+"</td>")}if(this.operate){e.append("<td>"+this.operate.content+"</td>")}this.$tbody.append(e)}if(this.pageable){this.renderPagination(a)}},renderPagination:function(t){var a=f(this.page,t),i=d('<div class="bs-data-table-pagination"></div>'),e=d('<select class="form-control bs-data-table-page-select"></select>'),s=d('<ul class="pagination bs-data-table-pagination"></ul>');var n=d('<li data-page="1"><a href="javascript:void(0);">&laquo;</a></li>');if(this.page<=1){n.addClass("disabled")}s.append(n);for(var r=0;r<a.length;r++){var o=d('<li data-page=":num"><a href="javascript:void(0);">:num</a></li>'.replace(/:num/g,a[r]));if(a[r]==this.page){o.addClass("active")}s.append(o)}var h=d('<li data-page=":totalPage"><a href="javascript:void(0);">&raquo;</a></li>'.replace(":totalPage",t));if(this.page==t){h.addClass("disabled")}s.append(h);i.append(s);if(t>0){for(var r=1;r<=t;r++){var p=d('<option value=":page">:page</option>'.replace(/:page/g,r));if(r==this.page){p.prop("selected",true)}e.append(p)}i.append('<span class="bs-data-table-page-total">/&nbsp;:totalPage</span>'.replace(":totalPage",t));i.append(e)}if(this.$pagination.length>0){this.$pagination.replaceWith(i);this.$pagination=i}else{this.$pagination=i;this.$table.after(this.$pagination)}var l=this;i.on("change",".bs-data-table-page-select",function(){l.page=d(this).val();l.renderData()}).on("click",".pagination li",function(){if(d(this).is(".disabled"))return;l.page=d(this).data("page");l.renderData()})},getIdx:function(t,a){a.apply(this,this.data.indexOf(t))},getData:function(t,a){var i=[];if(t instanceof Array){t.forEach(function(t){i.push(this.data[t])}.bind(this));a.apply(this,[i])}else{a.apply(this,[this.data[t]])}},getAllData:function(t){t.apply(this,this.data)},addData:function(t){if(t instanceof Array){t.forEach(function(t){this.data.push(t)}.bind(this))}else{this.data.push(t)}this.renderData()},removeData:function(t){if(t instanceof Array){t.forEach(function(t){this.data.splice(t,1)}.bind(this))}else{this.data.splice(t,1)}this.renderData()},replaceData:function(t,a){this.data.splice(t,1,a);this.renderData()},event:function(t){var a=this,i,e;if(arguments.length>2){i=arguments[1];e=arguments[2]}else{i="";e=arguments[1]}this.$tbody.on(t,"tr "+i,function(){var t=a.visibleData[d(this).index()];e.apply(this,[a.data.indexOf(t),t])})}};var r=function(t,i,a){t.sort(function(t,a){return e(t,a,i)});if(a){t.reverse()}};var e=function(t,a,i){if(i){t=c(t,i);a=c(a,i)}if(/^\d+$/.test(t)&&/^\d+$/.test(a)){t=Number(t);a=Number(a)}if(t>a||!a){return 1}else if(t<a||!t){return-1}return t.id>a.id?1:-1};var o=function(t,a){var i=[];t.forEach(function(t){if(!s(t,a)){i.push(t)}});return i};var s=function(t,a){for(var i in a){if(!a.hasOwnProperty(i)||i.endsWith("-strict")){continue}if(a[i+"-strict"]&&t[i]!=a[i]){return true}else if((t[i]+"").indexOf(a[i])==-1){return true}}return false};function f(t,a){var i=[],e=5,s=1;if(a<1){i.push(1);return i}if(a<=e){for(var n=1;n<=a;n++){i.push(n)}return i}s=t-Math.floor(e/2);s=s>0?s:1;s=s+e>a?a-e+1:s;for(var n=0;n<e;n++){i.push(s+n)}return i}var h=function(t){return t==undefined||t==""};var p=function(t,a,i,e){if(!h(t)&&!h(a)&&!h(i)){l(t,a,i,e)}};var l=function(t,a,i,e){var s=a.indexOf(".");if(s==-1){if(e=="list"){t[a]=t[a]||[];t[a].push(i)}else{t[a]=i}return}var n=a.substr(0,s);if(h(t[n])){t[n]={}}l(t[n],a.substr(s+1),i,e)};var c=function(t,a){return h(t)||h(a)?undefined:b(t,a)};var b=function(t,a){var i=a.indexOf(".");if(i==-1){return t[a]}var e=a.substr(0,i);if(h(t[e])){t[e]={}}return b(t[e],a.substr(i+1))};function u(t){return JSON.parse(JSON.stringify(t))}})(jQuery);