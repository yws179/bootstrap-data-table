/*
 * Plugin:  bootstrap-data-table
 * Author:  Weisen Yan (严伟森)
 * Version: 0.1.1
 * Email:   yws179@gmail.com
 * Github:  https://github.com/yws179/bootstrap-data-table
 * Licensed under the MIT license
 */
(function(l){l.fn.dataTable=function(e){var n=arguments;return this.each(function(){var t=l(this),i=t.data("dataTable"),a=typeof e=="object"&&e;if(!i){i=new s(t,a);t.data("dataTable",i)}if("string"===typeof e){i[e].apply(i,Array.prototype.slice.call(n,1))}})};var s=function(t,i){if(!t.is("table")){throw new Error("This is not <table> DOM")}this.$table=t;this.$caption=this.$table.find("caption");this.$thead=this.$table.find("thead");this.$tbody=this.$table.find("tbody");this.$pagination=this.$table.siblings(".pagination");this.options=i||{};this.data=this.options.data||[];this.visibleData=this.data;this.visibleCondition={};this.buttons=this.options.buttons||[];this.refreshable=this.options.refreshable;this.filterable=this.options.filterable;this.operate=this.options.operate;this.pageable=this.options.pageable;this.pageSize=this.options.pageSize||10;this.page=this.options.page||1;this._init()};s.prototype={constructor:s,_init:function(){this.$table.addClass("table table-striped table-bordered table-hover data-table");if(this.$caption.length<1){this.$caption=l("<caption></caption>");this.$table.prepend(this.$caption)}if(this.$thead.length<1){this.$thead=l("<thead></thead>");this.$caption.after(this.$thead)}if(this.$tbody.length<1){this.$tbody=l("<tbody></tbody>");this.$thead.after(this.$tbody)}this.rendCaption();this.renderHead();this.renderData()},rendCaption:function(){var t=l('<div class="btn-group pull-right"></div>');for(var i in this.buttons){var a=this.buttons[i],e=l(a.dom);for(var n in a.events){e.on(n,a.events[n])}t.append(e)}if(this.refreshable){var e=l('<button class="btn btn-default btn-refresh" type="button" title="刷新"><span class="glyphicon glyphicon-refresh"></span></button>');e.on("click",function(){var t=this.$thead.find("tr.data-table-filter");t.find(":input").val("");t.find(":input:first()").change()}.bind(this));t.append(e)}if(this.filterable){t.append('<button class="btn btn-default btn-filter" type="button" title="过滤器"><span class="glyphicon glyphicon-filter"></span></button>')}this.$caption.append(t);if(this.options.title){this.$caption.prepend(this.options.title)}},renderHead:function(){var t=l("<tr></tr>");for(var i in this.options.fields){var a=l('<div class="pull-right"></div>').append('<div class="btn-sort" data-sort-by=":sort-by" data-order="asc"><span class="glyphicon glyphicon-chevron-up"></span></div>'.replace(":sort-by",i)).append('<div class="btn-sort" data-sort-by=":sort-by" data-order="desc"><span class="glyphicon glyphicon-chevron-down"></span></div>'.replace(":sort-by",i));t.append(l("<th>"+this.options.fields[i]+"</th>").append(a))}if(this.operate){t.append("<th>"+(this.options.operate.field||"operate")+"</th>")}this.$thead.append(t);var e=this;this.$thead.find(".btn-sort").click(function(){var t=l(this),i=t.data("sort-by"),a=t.data("order");r(e.data,i,a=="desc");e.renderData()});if(this.filterable){var n=l('<tr class="data-table-filter"></tr>');for(var i in this.options.fields){n.append('<th><input class="form-control" name=":name"></th>'.replace(":name",i))}this.$thead.append(n);this.$caption.find(".btn-filter").click(function(){l(this).toggleClass("active");n.toggle();n.find(":input").val("");n.find(":input:first()").change()});this.$table.on("change keyup paste",".data-table-filter :input",function(){var a={};this.$table.find(".data-table-filter :input").each(function(){var t=l(this).attr("name");var i=l(this).val();if(l(this).data("strict")){p(a,t+"-strict",true)}p(a,t,i)});this.visibleCondition=a;this.renderData()}.bind(this))}},renderData:function(t){this.data=t||this.data;this.visibleData=o(t||this.data,this.visibleCondition);var i=Math.ceil(this.visibleData.length/this.pageSize);if(this.pageable){if(this.page>i){this.page=i}this.visibleData=Array.prototype.slice.call(this.visibleData,(this.page-1)*this.pageSize,Math.min(this.page*this.pageSize,this.visibleData.length))}this.$tbody.html("");for(var a in this.visibleData){var e=l("<tr></tr>");for(var n in this.options.fields){e.append("<td>"+(c(this.visibleData[a],n)||"")+"</td>")}if(this.operate){e.append("<td>"+this.operate.content+"</td>")}this.$tbody.append(e)}if(this.pageable){this.renderPagination(i)}},renderPagination:function(t){var i=f(this.page,t),a=l('<div class="data-table-pagination"></div>'),e=l('<select class="form-control data-table-page-select"></select>'),n=l('<ul class="pagination data-table-pagination"></ul>');a.prepend("<span>:page / :totalPage</span>".replace(":page",this.page).replace(":totalPage",t));var s=l('<li data-page="1"><a href="javascript:void(0);">&laquo;</a></li>');if(this.page<=1){s.addClass("disabled")}n.append(s);for(var r in i){var o=l('<li data-page=":num"><a href="javascript:void(0);">:num</a></li>'.replace(/:num/g,i[r]));if(i[r]==this.page){o.addClass("active")}n.append(o)}var h=l('<li data-page=":totalPage"><a href="javascript:void(0);">&raquo;</a></li>'.replace(":totalPage",t));if(this.page==t){h.addClass("disabled")}n.append(h);a.append(n);for(var r=1;r<=t;r++){var p=l('<option value=":page">:page</option>'.replace(/:page/g,r));if(r==this.page){p.prop("selected",true)}e.append(p)}a.append(e);if(this.$pagination.length>0){this.$pagination.replaceWith(a);this.$pagination=a}else{this.$pagination=a;this.$table.after(this.$pagination)}var d=this;a.on("click change",".pagination li, .data-table-page-select",function(){if(l(this).is(".disabled"))return;if(l(this).is("select")){d.page=l(this).val()}else{d.page=l(this).data("page")}d.renderData()})},getIdx:function(t,i){i.apply(this,this.data.indexOf(t))},getData:function(t,i){var a=[];if(t instanceof Array){t.forEach(function(t){a.push(this.data[t])}.bind(this));i.apply(this,[a])}else{i.apply(this,[this.data[t]])}},getAllData:function(t){t.apply(this,this.data)},addData:function(t){if(t instanceof Array){t.forEach(function(t){this.data.push(t)}.bind(this))}else{this.data.push(t)}this.renderData()},removeData:function(t){if(t instanceof Array){t.forEach(function(t){this.data.splice(t,1)}.bind(this))}else{this.data.splice(t,1)}this.renderData()},replaceData:function(t,i){this.data.splice(t,1,i);this.renderData()},event:function(t){var i=this,a,e;if(arguments.length>2){a=arguments[1];e=arguments[2]}else{a="";e=arguments[1]}this.$tbody.on(t,"tr "+a,function(){var t=i.visibleData[l(this).index()];e.apply(this,[i.data.indexOf(t),t])})}};var r=function(t,a,i){t.sort(function(t,i){return e(t,i,a)});if(i){t.reverse()}};var e=function(t,i,a){if(a){t=c(t,a);i=c(i,a)}if(/^\d+$/.test(t)&&/^\d+$/.test(i)){t=Number(t);i=Number(i)}if(t>i||!i){return 1}else if(t<i||!t){return-1}return t.id>i.id?1:-1};var o=function(t,i){var a=[];t.forEach(function(t){if(!n(t,i)){a.push(t)}});return a};var n=function(t,i){for(var a in i){if(!i.hasOwnProperty(a)||a.endsWith("-strict")){continue}if(i[a+"-strict"]&&t[a]!=i[a]){return true}else if((t[a]+"").indexOf(i[a])==-1){return true}}return false};function f(t,i){var a=[],e=5,n=1;if(i<1){a.push(1);return a}if(i<=e){for(var s=1;s<=i;s++){a.push(s)}return a}n=t-Math.floor(e/2);n=n>0?n:1;n=n+e>i?i-e+1:n;for(var s=0;s<e;s++){a.push(n+s)}return a}var h=function(t){return t==undefined||t==""};var p=function(t,i,a,e){if(!h(t)&&!h(i)&&!h(a)){d(t,i,a,e)}};var d=function(t,i,a,e){var n=i.indexOf(".");if(n==-1){if(e=="list"){t[i]=t[i]||[];t[i].push(a)}else{t[i]=a}return}var s=i.substr(0,n);if(h(t[s])){t[s]={}}d(t[s],i.substr(n+1),a,e)};var c=function(t,i){return h(t)||h(i)?undefined:u(t,i)};var u=function(t,i){var a=i.indexOf(".");if(a==-1){return t[i]}var e=i.substr(0,a);if(h(t[e])){t[e]={}}return u(t[e],i.substr(a+1))}})(jQuery);